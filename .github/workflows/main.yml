name: Build & Publish FastAPI backend (Compose → Docker Hub)

on:
  push:
    branches: [ aws-interactive-cicd ]

env:
  LOCAL_TAG: rosblocks-b:latest
  HUB_TAG:    juanandresc/rosblocks-b:latest

jobs:
  test:
    name: Build & Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # construye tu imagen una sola vez
      - name: Build backend image
        working-directory: Back-End
        run: docker compose build backend

      # levanta el servicio y corre tests...
      - name: Start & test
        working-directory: Back-End
        run: |
          docker compose up -d
          # espera a FastAPI…
          for i in {1..15}; do
            if curl -s http://localhost:8000/docs; then exit 0; fi
            sleep 2
          done
          pytest --cov=. --cov-fail-under=70
          docker compose down

      # empaqueta la imagen en un tar.gz
      - name: Save built image
        working-directory: Back-End
        run: |
          docker save $LOCAL_TAG | gzip > backend_image.tar.gz

      - uses: actions/upload-artifact@v3
        with:
          name: backend-image
          path: Back-End/backend_image.tar.gz

  publish:
    name: Tag & Push
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # descarga y “carga” la imagen prebuild
      - uses: actions/download-artifact@v3
        with:
          name: backend-image
          path: .

      - name: Load image into Docker
        run: |
          gzip -d backend_image.tar.gz
          docker load < backend_image.tar

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag & Push to Docker Hub
        run: |
          docker tag $LOCAL_TAG $HUB_TAG
          docker push $HUB_TAG
          echo "Pushed $HUB_TAG"
